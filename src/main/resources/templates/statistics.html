<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	th:replace="~{layouts/main-layout :: main-fragment(
	~{:: title},
	~{:: #statistics-header},
	~{:: #statistics-nav},
	~{:: #statistics-main-content},
	~{:: #statistics-footer}
	)}"
	>
	<head>
		<title>Statistics</title>
	</head>
	<body>

		<div id="statistics-header">
			Statistics
		</div>
		<br>
		<div id="statistics-nav" th:replace="~{/fragments/main-fragments :: nav-default}">
			Statistics Nav
		</div>

		<div id="statistics-main-content">
            
            <form method="POST" th:action="@{/statistics}" id="statisticsForm" class="container">
                 <div class="form-floating">
                    <select  id="clientSelector" class="form-select" aria-labeled="clients" name="client">
                        <option value="" selected>Seleccione un Cliente</option>
                        <option th:each="itClient: ${clients}" th:value="${itClient.id}"
                            th:selected="(${itClient.id} ==  ${clientId})"                               
                            th:text="${itClient.firstName} + ' ' + ${itClient.lastName}"
                            class="dropdown-item" href="#"
                                >
                        </option>
                    </select>
                     <label class="form-check-label" for="clientSelector">Client</label>
                </div>
				<div class="form-floating">
                    <select  id="treatmentSelector" class="form-select" aria-labeled="treatments" name="treatment">
                        <option value="" selected>Seleccione un Tratamiento</option>
                        <option th:each="itTreatment: ${treatments}" th:value="${itTreatment.id}"
                            th:selected="(${itTreatment.id} ==  ${treatmentId})"                               
                            th:text="${itTreatment.name}"
                            class="dropdown-item" href="#"
                                >
                        </option>
                    </select>
                     <label class="form-check-label" for="treatmentSelector">Tratamiento</label>
                </div>	
				<div class="form-floating">
                    <select  id="paidSelector" class="form-select" aria-labeled="appointments" name="paidAppointment">
                   	<option value="" selected> Seleccione pagadas, no pagadas o todas</option>
					<option th:value="true" th:selected="${paidAppointment} == true">Pagado</option> 
					<option th:value="false"th:selected="${paidAppointment} == false">No pagado</option>
                    </select>
                     <label class="form-check-label" for="paidSelector">Pagos</label>
                </div>		
				<div class="form-floating">
                    <select  id="doneSelector" class="form-select" aria-labeled="appointments" name="doneAppointment">
                   	<option value="" selected> Seleccione realizadas, no realizadas o todas</option>
					<option th:value="true" th:selected="${doneAppointment} == true">Realizada</option> 
					<option th:value="false"th:selected="${doneAppointment} == false">No realizada</option>
                    </select>
                     <label class="form-check-label" for="doneSelector">Pagos</label>
                </div>	

				<div class="form-group">
					<div class="input-group justify-content-center">
						<span class="input-group-text" id="addon-wrapping">Fecha inicial</span>
						<input type="datetime-local" name = "initialDate" th:value = "${initialDate}"/>
					</div>
				</div>
				
				<div class="form-group">
					<div class="input-group justify-content-center">
						<span class="input-group-text" id="addon-wrapping">Fecha final</span>
						<input type="datetime-local" name="endDate" th:value = "${endDate}" />
					</div>
				</div>
				<br>

                <div style="margin-bottom: 10px; text-align: center;">
                    <button type="submit" class="btn btn-primary">Buscar</button>
                </div>

            </form>
            <table class="table table-success table-striped">
				<thead class="thead">
					<tr>
						<th style="text-align: center;">Cliente</th>
						<th style="text-align: center;">Fecha</th>
						<th style="text-align: center;">Tratamiento</th>
                        <th style="text-align: center;">Precio</th>
						<th style="text-align: center;">Realizada</th>
						<th style="text-align: center;">Pagada</th>
                        
					</tr>
				</thead>
				<tr th:each="appointment : ${appointments}">
					<td th:text="${appointment.client.firstName} + ' ' + ${appointment.client.lastName}" style="text-align: center;">Cliente</td>
					<td th:text="${#temporals.format(appointment.appointmentDate)}" style="text-align: center;">Fecha</td>
					<td th:text="${appointment.treatment.name}" style="text-align: center;">Tratamiento</td>
					<td th:text="${appointment.treatment.price}" style="text-align: center;">Precio</td>
                    <td class="text-center" style="font-size: 20px">
						<span th:if="${appointment.done == true}"> <i class="fa-solid fa-circle-check text-success"></i></span>
						<span th:if="${appointment.done == false}"> <i class="fa-solid fa-circle-xmark text-danger"></i></span>
					</td>
					<td class="text-center" style="font-size: 20px">
						<span th:if="${appointment.paid == true}"> <i class="fa-solid fa-circle-check text-success"></i></span>
						<span th:if="${appointment.paid == false}"> <i class="fa-solid fa-circle-xmark text-danger"></i></span>
					</td>
				</tr>
			</table>
			<p>Los ingresos totales son:</p>
			<p th:text="${ingresosTotales}"> </p>

			<script src="https://code.highcharts.com/highcharts.js"></script>
			<script src="https://code.highcharts.com/highcharts-3d.js"></script>
			<script src="https://code.highcharts.com/modules/exporting.js"></script>

			<div id="container" style="height: 400px"></div>
			<script th:inline="javascript">
				/*<![CDATA[*/
				var jmap = /*[[${maptreatapp}]]*/ 'defaultmap';
    			/*]]>*/
				/*[+
				var chartdata = []
				var i = 0;
				console.log(jmap);
				Object.keys(jmap).forEach(function(key) {
					var data = jmap[key]; 
					console.log("data is: " + data);
					chartdata[i++] = [key, data];
				});
				console.log(chartdata);
				
				+]*/
				Highcharts.chart('container', {
					chart : {
						type : 'pie',
						options3d : {
							enabled : true,
							alpha : 50,
							beta : 0
						}
					},
					title : {
						text : 'Citas por tipo de tratamiento'
					},
					tooltip : {
						pointFormat : '{series.name}: <b>{point.percentage:.1f}%</b>'
					},
					plotOptions : {
						pie : {
							allowPointSelect : true,
							cursor : 'pointer',
							depth : 35,
							dataLabels : {
								enabled : true,
								format : '{point.name}'
							}
						}
					},
					
					series : [ {
						type : 'pie',
						name : 'Ratio',
						data : chartdata
					} ]
				});
			</script>
			</div>
        <div>
			<a href="appointments/new" id="new" class="btn btn-success" role="button" style="width: 100%"><i class="fa fa-fw fa-calendar-plus" aria-hidden="true"></i></a>
		</div>
	</body>
</html>
